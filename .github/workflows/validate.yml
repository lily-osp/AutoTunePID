name: Validate Arduino Library

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  validate:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Validate Arduino Library Structure
      run: |
        echo "üîç Validating Arduino Library Structure..."

        # Check for required files
        REQUIRED_FILES=("src/AutoTunePID.h" "src/AutoTunePID.cpp" "library.properties" "keywords.txt" "LICENSE" "README.md")
        for file in "${REQUIRED_FILES[@]}"; do
          if [ ! -f "$file" ]; then
            echo "‚ùå Missing required file: $file"
            exit 1
          else
            echo "‚úÖ Found: $file"
          fi
        done

        # Check for examples directory
        if [ ! -d "examples" ]; then
          echo "‚ùå Missing examples directory"
          exit 1
        else
          echo "‚úÖ Found examples directory"
        fi

        # Validate library.properties format
        echo "üîç Validating library.properties..."
        if ! grep -q "^name=" library.properties; then
          echo "‚ùå library.properties missing 'name' field"
          exit 1
        fi

        if ! grep -q "^version=" library.properties; then
          echo "‚ùå library.properties missing 'version' field"
          exit 1
        fi

        if ! grep -q "^author=" library.properties; then
          echo "‚ùå library.properties missing 'author' field"
          exit 1
        fi

        if ! grep -q "^maintainer=" library.properties; then
          echo "‚ùå library.properties missing 'maintainer' field"
          exit 1
        fi

        echo "‚úÖ library.properties validation passed"

        # Check keywords.txt format
        echo "üîç Validating keywords.txt..."
        if [ ! -s "keywords.txt" ]; then
          echo "‚ùå keywords.txt is empty"
          exit 1
        fi

        # Check for tabs in keywords.txt (Arduino IDE requirement)
        if grep -q " " keywords.txt && ! grep -q $'\t' keywords.txt; then
          echo "‚ùå keywords.txt should use tabs, not spaces"
          exit 1
        fi

        echo "‚úÖ keywords.txt validation passed"

        # Validate version format (semantic versioning)
        VERSION=$(grep "^version=" library.properties | cut -d'=' -f2)
        if ! echo "$VERSION" | grep -qE '^[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9.-]+)?$'; then
          echo "‚ùå Version '$VERSION' does not follow semantic versioning (e.g., 1.2.3)"
          exit 1
        fi

        echo "‚úÖ Version format validation passed: $VERSION"

        # Check for emoji-free documentation
        echo "üîç Checking for professional documentation..."
        if grep -r "üòÄ\|üòÇ\|üòä\|üëç\|üî•\|‚ú®\|üöÄ\|üí°\|üìö\|üéØ\|‚úÖ\|‚ùå\|üîç\|üîß\|üìã\|üéØ\|üìä\|üéØ\|üöÄ" docs/ 2>/dev/null; then
          echo "‚ö†Ô∏è  Warning: Emojis found in documentation (consider removing for professional appearance)"
        else
          echo "‚úÖ Documentation is emoji-free"
        fi

        echo "üéâ All validations passed!"

    - name: Test Library Compilation
      run: |
        echo "üîß Testing Arduino Library Compilation..."

        # Install Arduino CLI
        curl -fsSL https://raw.githubusercontent.com/arduino/arduino-cli/master/install.sh | sh
        export PATH="$PWD/bin:$PATH"

        # Install AVR core
        arduino-cli core install arduino:avr

        # Test compilation of all examples
        FAILED_EXAMPLES=()
        for example_dir in examples/*/; do
          if [ -f "$example_dir/$(basename $example_dir).ino" ]; then
            echo "Testing $(basename $example_dir)..."
            if ! arduino-cli compile --libraries . --fqbn arduino:avr:uno "$example_dir/$(basename $example_dir).ino" >/dev/null 2>&1; then
              FAILED_EXAMPLES+=("$(basename $example_dir)")
              echo "‚ùå $(basename $example_dir) failed to compile"
            else
              echo "‚úÖ $(basename $example_dir) compiled successfully"
            fi
          fi
        done

        if [ ${#FAILED_EXAMPLES[@]} -gt 0 ]; then
          echo "‚ùå Compilation failed for: ${FAILED_EXAMPLES[*]}"
          exit 1
        fi

        echo "üéâ All examples compiled successfully!"
